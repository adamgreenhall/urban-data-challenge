<!DOCTYPE html>
<html lang="en">
<head>
  <title>San Francisco MUNI Stops</title>
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />
  <script src="http://cdn.leafletjs.com/leaflet-0.5/leaflet.js"></script>
  <script type="text/javascript" src="d3.js"></script>
  <!-- <script src="stop_map.js"></script> -->
  <style type="text/css">
    #map { 
      height: 600px;
      width: 600px;
    }
    circle {
      fill: steelblue;
      fill-opacity: 0.7;
    }
    circle:hover {fill: black;}
  </style>
</head>
<body>
  <div id="map"></div>
  
  <script type="text/javascript">
    var map = L.map('map', {
        center: [37.76603099825176, -122.43186179720293],
        zoom: 12
        }).addLayer(
          new L.tileLayer('http://{s}.tile.cloudmade.com/62541519723e4a6abd36d8a4bb4d6ac3/998/256/{z}/{x}/{y}.png', {
            attribution: '',
            maxZoom: 16,
          }));
          
    var svg = d3.select(map.getPanes().overlayPane).append("svg"),
    g = svg.append("g").attr("class", "leaflet-zoom-hide");
        
    function projection(x) {
      var point = map.latLngToLayerPoint(new L.LatLng(x[0], x[1]));
      return [point.x, point.y];
    }        
    
    var path = d3.geo.path().projection(projection);
    
    
    d3.json("stops_sf.json", function(stops) {
      var dots = g.selectAll("circle")
        .data(stops).enter()
        .append("circle")
        .attr("r", 5)
        .on("mouseover", function(d){
          d3.select(this)
            .attr('r', 10)
            .attr("class", "hover")
        })
        .on("mouseout", function(d){
          d3.select(this)
            .attr('r', 5)
            .attr("class", "")
        })
      
      var bounds = [
        [ 
          d3.min(stops, function(d){return d.lat}), 
          d3.min(stops, function(d){return d.long})  ],
        [ 
          d3.max(stops, function(d){return d.lat}), 
          d3.max(stops, function(d){return d.long}) ]
        ];
      console.log(bounds)
      map.on("viewreset", reset);
      reset();
      
      // Reposition the SVG to cover the features.
      function reset() {
        var bottomLeft = projection(bounds[0]),
            topRight = projection(bounds[1]);
            
        svg.attr("width", topRight[0] - bottomLeft[0])
            .attr("height", bottomLeft[1] - topRight[1])
            .style("margin-left", bottomLeft[0] + "px")
            .style("margin-top", topRight[1] + "px");
        
        g.attr("transform", "translate(" + -bottomLeft[0] + "," + -topRight[1] + ")");
        dots.attr("transform", function(d){
          return "translate(" + projection([d.lat, d.long]) + ")"; })
      }

    });
    
    
  </script>

</body>
</html>