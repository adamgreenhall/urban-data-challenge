<!DOCTYPE html>
<html lang="en">
<head>
  <title>San Francisco MUNI Stops</title>
  <link rel="stylesheet" href="leaflet.css" />
  <script type="text/javascript" src="leaflet.js"></script>
  <script type="text/javascript" src="d3.js"></script>
  <script type="text/javascript" src="topojson.js"></script>
  
  <!-- <script src="stop_map.js"></script> -->
  <style type="text/css">
    #map { 
      height: 600px;
      width: 600px;
    }
    circle {
      fill: steelblue;
      fill-opacity: 0.7;
    }
    circle:hover {fill: black;}
    path.bus-route{
      fill: none;
      stroke: black;
    }
		#tooltip {
			position: absolute;
			width: 200px;
			height: auto;
			padding: 10px;
			background-color: white;
			-webkit-border-radius: 10px;
			-moz-border-radius: 10px;
			border-radius: 10px;
			-webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
			-moz-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
			box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
			pointer-events: none;
			z-index: 100;
		}

		#tooltip.hidden {
			display: none;
		}

		#tooltip p {
			margin: 0;
			font-family: sans-serif;
			font-size: 16px;
			line-height: 20px;
		}    
  </style>
</head>
<body>
	<div id="tooltip" class="hidden">
		<p>
		  <span class="route-name" style="font-weight: bold"></span>
		  <span class="stop-name"></span>
		</p>
	</div>  
  <div id="map"></div>
  

  <script type="text/javascript">
    var city = 'san-francisco',
        centers = {
          'san-francisco': [37.783333, -122.416667],
          'geneva': [46.2, 6.15],
          'zurich': [47.366667, 8.55]
    };
  
    var map = L.map('map', {
        center: centers[city],
        zoom: 12
        }).addLayer(
          new L.tileLayer('http://{s}.tile.cloudmade.com/62541519723e4a6abd36d8a4bb4d6ac3/998/256/{z}/{x}/{y}.png', {
            attribution: '',
            maxZoom: 16,
          }));
          
    var svg = d3.select(map.getPanes().overlayPane).append("svg"),
    g = svg.append("g").attr("class", "leaflet-zoom-hide");
        
    function projection(x) {
      pt = map.latLngToLayerPoint(new L.LatLng(x[1], x[0]));
      return [pt.x, pt.y];
    }        
    
    var path = d3.geo.path()
      .projection(projection)
        
    var tooltip = d3.select("#tooltip");
    
    var bus_routes = undefined,
        bus_stops = undefined,
        stop_coordinates = undefined,
        bounds = undefined;
    
    d3.json(city + "/stops.json", function(stops) {
      // convert back to lat-long coordinates
      stop_coordinates = topojson.object(stops, {
        type: "MultiPoint",   
        coordinates: stops.objects.stops.geometries.map(function(d){return d.coordinates})
      }).coordinates;
      
      bus_stops = g.selectAll("circle")
        .data(stops.objects.stops.geometries).enter()
        .append("circle")
        .attr("r", 3)
        .on("mouseover", function(d) {

          var dot = d3.select(this)
          dot
            .attr('r', 10)
            .classed("hover", true)

					//Get this bar's x/y values, then augment for the tooltip
					var xPosition = parseFloat(dot.attr("cx"));
					var yPosition = parseFloat(dot.attr("cy"));

					//Update the tooltip position and value
					tooltip
						.style("left", xPosition + 10 + "px")
						.style("top", yPosition + 10 + "px");

					tooltip.select(".route-name").text(d.properties.name_route);
					tooltip.select(".stop-name").text(d.properties.name_stop);

					//Show the tooltip
					tooltip.classed("hidden", false);
			   })
			   .on("mouseout", function() {
          d3.select(this)
            .attr('r', 5)
            .classed("hover", false)

					//Hide the tooltip
					tooltip.classed("hidden", true);
			   })
        
        bounds = [
          [ 
            d3.min(stop_coordinates, function(d){return d[0]}),     // long
            d3.min(stop_coordinates, function(d){return d[1]}),     // lat
          ],
          [ 
            d3.max(stop_coordinates, function(d){return d[0]}),
            d3.max(stop_coordinates, function(d){return d[1]}), 
            ]
          ];
      

      map.on("viewreset", reset);
      reset();      

      // define all bus lines together
      d3.json(city + "/routes.json", function(routes) {
        bus_routes = g.append("path")
          .datum(topojson.object(routes, routes.objects.routes))
          .attr({
            class: 'bus-route',
            d: path,
          })
      });      

      // // define each line individually
      // d3.json(city + "/routes.json", function(routes) {
      //   bus_routes = g.selectAll("path.bus-route")
      //     .data(topojson.object(routes, routes.objects.routes).geometries).enter()
      //     .append('path')
      //     .attr({
      //       class: 'bus-route',
      //       d: path,
      //     })
      // });      

    });  

  // Reposition the SVG to cover the features.
  function reset() {
    if (bounds === undefined){
      return
    }
    
    var bottomLeft = projection(bounds[0]),
        topRight = projection(bounds[1]);
      
    svg.attr("width", topRight[0] - bottomLeft[0])
        .attr("height", bottomLeft[1] - topRight[1])
        .style("margin-left", bottomLeft[0] + "px")
        .style("margin-top", topRight[1] + "px");

    g.attr("transform", "translate(" + -bottomLeft[0] + "," + -topRight[1] + ")");
    
    if (bus_stops !== undefined) {
      bus_stops.attr({
        cx: function(d, i){return projection(stop_coordinates[i])[0]},
        cy: function(d, i){return projection(stop_coordinates[i])[1]},
        });      
    }
    if (bus_routes !== undefined) {
      bus_routes.attr('d', path);
    }
  }

    
  </script>

</body>
</html>