<!DOCTYPE html>
<html lang="en">
<head>
  <title>Stop motion demo</title>
  <script type="text/javascript" src="d3.js"></script>
  <style type="text/css">
    circle.bus {
      fill: steelblue;
    }
    circle.bus-stop {
      fill: grey;
      fill-opacity: 0.7;
    }
    line.bus-line {
      stroke: rgba(6, 120, 155, 0.8);
      fill: none;
      stroke-width: 2px;
      shape-rendering: crispEdges;
    }
  </style>
</head>
<body>
  <div id="chart"></div>
  
  <script type="text/javascript">
    var margin = {top: 20, right: 20, bottom: 20, left: 20};
    var width = 600 - margin.left - margin.right,
        height = 300 - margin.top - margin.bottom;
        
    var svg = d3.select('#chart').append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)

    var g = svg.append("g")
      .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    
    var data = [
      {time: 0, x: 10},
      {time: 2, x: 150},
      {time: 5, x: 450},      
      ];

    // make a time scale to map all events to 2sec
    var Tmax = 2000;
    var tScale = d3.scale.linear()
      .domain(d3.extent(data, function(d){return d.time}))
      .range([0, Tmax])
      
    var xScale = d3.scale.linear()
      .domain(d3.extent(data, function(d){return d.x}))
      .range([0, width])

    var yPos = height / 2;
    var line = g.append('line').attr({
        x1: xScale.range()[0],
        x2: xScale.range()[1],
        y1: yPos,
        y2: yPos,
        class: 'bus-line'
        });

    var stops = g.selectAll('circle').
      data(data).enter().append('circle')
      .attr({
        class: 'bus-stop',
        r: 3,
        cx: function(d){return xScale(d.x)},
        cy: yPos,
      });

    var bus = g.append('circle').attr({
      class: 'bus',
      r: 5,
      cx: xScale(data[0].x),
      cy: yPos
    });
    
    var reset_to_beginning = function(reset_duration){
      reset_duration = reset_duration || 2000;
      bus.transition().duration(reset_duration * 4/5)
        .style("fill-opacity", 0)
        .each("end", 
          // at the end of the fade out
          function(){
            // reset the position to t0
            bus.attr('cx', xScale(data[0].x))
            // fade the bus back in
            bus.transition().duration(reset_duration / 5)
              .style("fill-opacity", 1)
            }
          )
      // re-trigger the first event after the 
      // transition to starting state is complete
      d3.timer(function(){
          trigger_event(0); 
          return true;
        }, reset_duration)
      
    }

    var trigger_event = function(event_number){
      var event_length = tScale(data[event_number].time);
      bus.transition()
        .duration(event_length)
        .attr('cx', xScale(data[event_number].x));

      d3.timer(function(){
        // trigger next after transition is done
        if(event_number < data.length - 1){
          trigger_event(event_number + 1);
        } else {
          reset_to_beginning();
        }
        return true;
      }, event_length)
    };

    // start things moving
    trigger_event(0);
    
  </script>

</body>
</html>